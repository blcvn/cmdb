openapi: 3.0.3
info:
  title: CMDB API
  description: |
    Configuration Management Database (CMDB) API provides comprehensive management
    of Configuration Items (CIs), CI Types, relationships, topology, IPAM, and more.
  version: 1.0.0
  contact:
    name: CMDB API Support
    email: support@cmdb.local

servers:
  - url: http://localhost:5000
    description: Local development server
  - url: https://cmdb.example.com
    description: Production server

tags:
  - name: Authentication
    description: User authentication and authorization
  - name: CI
    description: Configuration Item management
  - name: CI Type
    description: CI Type definition and management
  - name: CI Relation
    description: CI relationship management
  - name: CI Type Relation
    description: CI Type relationship definition
  - name: Topology
    description: Topology views and graph visualization
  - name: IPAM
    description: IP Address Management
  - name: Auto Discovery
    description: Auto-discovery rules and discovered CIs
  - name: Attribute
    description: Attribute definition and management
  - name: History
    description: CI and relation history tracking
  - name: ACL
    description: Access Control List management
  - name: Common Setting
    description: Common settings and configuration
  - name: DCIM
    description: Data Center Infrastructure Management
  - name: Preference
    description: User preferences and settings

paths:
  # Authentication
  /api/login:
    post:
      tags:
        - Authentication
      summary: User login
      description: Authenticate user and get JWT token
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - username
                - password
              properties:
                username:
                  type: string
                  description: Username or email
                password:
                  type: string
                  format: password
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 200
                  message:
                    type: string
                    example: success
                  token:
                    type: string
                    description: JWT token
                  username:
                    type: string
        '401':
          description: Invalid credentials

  /api/logout:
    post:
      tags:
        - Authentication
      summary: User logout
      responses:
        '200':
          description: Logout successful

  /api/auth_with_key:
    post:
      tags:
        - Authentication
      summary: Authenticate with API key
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - key
                - secret
                - path
              properties:
                key:
                  type: string
                secret:
                  type: string
                path:
                  type: string

  # CI Management
  /api/v0.1/ci:
    get:
      tags:
        - CI
      summary: Get CI by ID
      parameters:
        - name: ci_id
          in: query
          required: true
          schema:
            type: integer
        - name: fields
          in: query
          schema:
            type: string
            description: Comma-separated field names
        - name: ret_key
          in: query
          schema:
            type: string
            enum: [name, alias, id]
            default: name
      responses:
        '200':
          description: CI details
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  ci_id:
                    type: integer
                  ci:
                    type: object

    post:
      tags:
        - CI
      summary: Create new CI
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - ci_type
              properties:
                ci_type:
                  type: string
                  description: CI type name
                exist_policy:
                  type: string
                  enum: [REJECT, ACCEPT, UPDATE]
                ticket_id:
                  type: integer
      responses:
        '200':
          description: CI created
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  ci_id:
                    type: integer

  /api/v0.1/ci/{ci_id}:
    get:
      tags:
        - CI
      summary: Get CI by ID
      parameters:
        - name: ci_id
          in: path
          required: true
          schema:
            type: integer
        - name: fields
          in: query
          schema:
            type: string
        - name: ret_key
          in: query
          schema:
            type: string
            enum: [name, alias, id]
      responses:
        '200':
          description: CI details

    put:
      tags:
        - CI
      summary: Update CI
      parameters:
        - name: ci_id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
      responses:
        '200':
          description: CI updated

    delete:
      tags:
        - CI
      summary: Delete CI
      parameters:
        - name: ci_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: CI deleted

  /api/v0.1/ci/type/{type_id}:
    get:
      tags:
        - CI
      summary: Get CIs by type
      parameters:
        - name: type_id
          in: path
          required: true
          schema:
            type: integer
        - name: fields
          in: query
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: count
          in: query
          schema:
            type: integer
            default: 20
        - name: ret_key
          in: query
          schema:
            type: string
            enum: [name, alias, id]
      responses:
        '200':
          description: List of CIs
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  type_id:
                    type: integer
                  numfound:
                    type: integer
                  page:
                    type: integer
                  cis:
                    type: array
                    items:
                      type: object

  /api/v0.1/ci/s:
    get:
      tags:
        - CI
      summary: Search CIs
      parameters:
        - name: q
          in: query
          schema:
            type: string
            description: Search query
        - name: fl
          in: query
          schema:
            type: string
            description: Field list
        - name: page
          in: query
          schema:
            type: integer
        - name: count
          in: query
          schema:
            type: integer
        - name: sort
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Search results

  # CI Type Management
  /api/v0.1/ci_types:
    get:
      tags:
        - CI Type
      summary: List CI types
      parameters:
        - name: type_name
          in: query
          schema:
            type: string
        - name: type_ids
          in: query
          schema:
            type: string
            description: Comma-separated type IDs
      responses:
        '200':
          description: List of CI types
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  numfound:
                    type: integer
                  ci_types:
                    type: array
                    items:
                      type: object

    post:
      tags:
        - CI Type
      summary: Create CI type
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                alias:
                  type: string
                enabled:
                  type: boolean
      responses:
        '200':
          description: CI type created
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  type_id:
                    type: integer

  /api/v0.1/ci_types/{type_id}:
    get:
      tags:
        - CI Type
      summary: Get CI type by ID
      parameters:
        - name: type_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: CI type details

    put:
      tags:
        - CI Type
      summary: Update CI type
      parameters:
        - name: type_id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
      responses:
        '200':
          description: CI type updated

    delete:
      tags:
        - CI Type
      summary: Delete CI type
      parameters:
        - name: type_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: CI type deleted

  /api/v0.1/ci_types/{type_id}/attributes:
    get:
      tags:
        - CI Type
      summary: Get CI type attributes
      parameters:
        - name: type_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: List of attributes

    post:
      tags:
        - CI Type
      summary: Add attribute to CI type
      parameters:
        - name: type_id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - attr_id
              properties:
                attr_id:
                  type: integer
                is_required:
                  type: boolean
                is_unique:
                  type: boolean
      responses:
        '200':
          description: Attribute added

  # CI Relations
  /api/v0.1/ci_relations:
    post:
      tags:
        - CI Relation
      summary: Create CI relation
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - first_ci_id
                - second_ci_id
                - relation_type_id
              properties:
                first_ci_id:
                  type: integer
                second_ci_id:
                  type: integer
                relation_type_id:
                  type: integer
      responses:
        '200':
          description: Relation created

  /api/v0.1/ci_relations/{first_ci_id}/{second_ci_id}:
    get:
      tags:
        - CI Relation
      summary: Get CI relation
      parameters:
        - name: first_ci_id
          in: path
          required: true
          schema:
            type: integer
        - name: second_ci_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Relation details

    delete:
      tags:
        - CI Relation
      summary: Delete CI relation
      parameters:
        - name: first_ci_id
          in: path
          required: true
          schema:
            type: integer
        - name: second_ci_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Relation deleted

  /api/v0.1/ci_relations/s:
    get:
      tags:
        - CI Relation
      summary: Search CI relations
      parameters:
        - name: q
          in: query
          schema:
            type: string
        - name: root_id
          in: query
          schema:
            type: integer
        - name: level
          in: query
          schema:
            type: integer
            default: 1
        - name: page
          in: query
          schema:
            type: integer
        - name: count
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: Search results

  # Topology
  /api/v0.1/topology/graph:
    get:
      tags:
        - Topology
      summary: Get topology graph
      parameters:
        - name: root_id
          in: query
          required: true
          schema:
            type: integer
        - name: level
          in: query
          schema:
            type: integer
            default: 1
        - name: ci_type_ids
          in: query
          schema:
            type: string
            description: Comma-separated CI type IDs
      responses:
        '200':
          description: Topology graph data
          content:
            application/json:
              schema:
                type: object
                properties:
                  nodes:
                    type: array
                    items:
                      type: object
                  edges:
                    type: array
                    items:
                      type: object

  /api/v0.1/topology_views:
    get:
      tags:
        - Topology
      summary: List topology views
      responses:
        '200':
          description: List of topology views

    post:
      tags:
        - Topology
      summary: Create topology view
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                group_id:
                  type: integer
      responses:
        '200':
          description: Topology view created

  # IPAM
  /api/v0.1/ipam/subnet:
    get:
      tags:
        - IPAM
      summary: Get subnet tree
      responses:
        '200':
          description: Subnet tree structure

    post:
      tags:
        - IPAM
      summary: Create subnet
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - cidr
              properties:
                cidr:
                  type: string
                  format: cidr
                parent_id:
                  type: integer
      responses:
        '200':
          description: Subnet created

  /api/v0.1/ipam/subnet/{subnet_id}:
    get:
      tags:
        - IPAM
      summary: Get subnet by ID
      parameters:
        - name: subnet_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Subnet details

    put:
      tags:
        - IPAM
      summary: Update subnet
      parameters:
        - name: subnet_id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
      responses:
        '200':
          description: Subnet updated

    delete:
      tags:
        - IPAM
      summary: Delete subnet
      parameters:
        - name: subnet_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Subnet deleted

  /api/v0.1/ipam/stats:
    get:
      tags:
        - IPAM
      summary: Get IPAM statistics
      responses:
        '200':
          description: IPAM statistics

  # Auto Discovery
  /api/v0.1/adr:
    get:
      tags:
        - Auto Discovery
      summary: List auto-discovery rules
      responses:
        '200':
          description: List of discovery rules

    post:
      tags:
        - Auto Discovery
      summary: Create auto-discovery rule
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - name
                - ci_type_name
                - discovery_type
              properties:
                name:
                  type: string
                ci_type_name:
                  type: string
                discovery_type:
                  type: string
                  enum: [plugin, snmp, http]
                enabled:
                  type: boolean
      responses:
        '200':
          description: Rule created

  /api/v0.1/adc:
    get:
      tags:
        - Auto Discovery
      summary: List discovered CIs
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [QUEUED, ACCEPTED, REJECTED]
      responses:
        '200':
          description: List of discovered CIs

  /api/v0.1/adc/{adc_id}/accept:
    post:
      tags:
        - Auto Discovery
      summary: Accept discovered CI
      parameters:
        - name: adc_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: CI accepted

  # History
  /api/v0.1/history/ci/{ci_id}:
    get:
      tags:
        - History
      summary: Get CI history
      parameters:
        - name: ci_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: CI history records

  # ACL
  /api/v1/acl/apps:
    get:
      tags:
        - ACL
      summary: List applications
      responses:
        '200':
          description: List of applications

  /api/v1/acl/roles:
    get:
      tags:
        - ACL
      summary: List roles
      responses:
        '200':
          description: List of roles

    post:
      tags:
        - ACL
      summary: Create role
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
      responses:
        '200':
          description: Role created

  /api/v1/acl/users:
    get:
      tags:
        - ACL
      summary: List users
      responses:
        '200':
          description: List of users

    post:
      tags:
        - ACL
      summary: Create user
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - username
                - email
              properties:
                username:
                  type: string
                email:
                  type: string
                password:
                  type: string
      responses:
        '200':
          description: User created

  # Common Setting
  /api/common-setting/v1/employee:
    get:
      tags:
        - Common Setting
      summary: List employees
      responses:
        '200':
          description: List of employees

    post:
      tags:
        - Common Setting
      summary: Create employee
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - username
                - email
              properties:
                username:
                  type: string
                email:
                  type: string
      responses:
        '200':
          description: Employee created

  /api/common-setting/v1/department:
    get:
      tags:
        - Common Setting
      summary: List departments
      responses:
        '200':
          description: List of departments

    post:
      tags:
        - Common Setting
      summary: Create department
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
      responses:
        '200':
          description: Department created

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    sessionAuth:
      type: apiKey
      in: cookie
      name: session

security:
  - bearerAuth: []
  - sessionAuth: []

